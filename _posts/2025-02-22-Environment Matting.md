---
layout: mypost
title: Environment Matting and Compositing
categories: [Environment Matting]
---


# 核心内容讲解

这篇论文《Environment Matting and Compositing》由Douglas E. Zongker等人撰写，主要介绍了一种新的图像处理技术，称为环境遮罩（environment matting），它能够捕捉前景物体及其对光线的折射和反射特性，并将这些特性用于新的环境合成（environment compositing）中，以实现更真实的视觉效果。下面我将为你详细解读这篇论文的核心内容：

### 背景知识
- **Matting和Compositing**：在图形学中，matting过程是从背景图像中提取任意形状的前景元素，并描述其在每个点的不透明度。compositing过程则是将前景元素放置在新的背景图像上，使用遮罩来遮挡前景元素遮挡的新背景部分。传统的matting和compositing技术在电影、视频和计算机图形制作中被广泛应用，但它们未能模拟真实世界中的两个关键效果：**折射**和**反射**。

### 研究方法
- **Environment Matte**：作者提出了一种新的结构，称为环境遮罩，它不仅捕捉前景物体的颜色和不透明度，还描述了物体如何折射和反射环境中的光线。环境遮罩允许前景物体在新环境中产生折射和反射效果，包括光泽和半透明效果，以及根据波长选择性衰减和散射光线。
- **Environment Compositing**：通过环境遮罩，可以将前景物体合成到新环境中，并且能够快速运行在桌面PC上，实现交互式速度。

### 实验和结果
- **实验设置**：作者构建了一个实验系统，使用数字相机和多个显示器来获取环境遮罩。他们将三个显示器放置在与立方体环境的三个面一致的位置，并使用20英寸的Trinitron显示器，调整显示以使洋红色和绿色图像尽可能一致。使用Kodak DCS 520数字相机拍摄物体，并循环显示每个显示器上的图像。
- **结果**：通过环境遮罩技术，作者成功地将玻璃烛台、玻璃书挡等物体合成到新的背景中，展示了复杂的折射和反射效果。例如，玻璃烛台的两个凸起产生了复杂的折射图案，环境遮罩能够准确地重现这些效果。此外，环境遮罩还能够处理彩色透明度，更准确地再现背景颜色通过有色物体过滤后的效果。

### 关键结论
- **环境遮罩的有效性**：环境遮罩能够捕捉并重现物体的折射和反射特性，使得合成的图像更加真实。通过与传统alpha通道合成的对比，环境遮罩在处理透明和反光物体时表现出明显的优势。
- **交互式速度**：环境合成过程主要使用纹理映射操作，可以在桌面PC上以交互式速度运行，这对于虚拟和增强现实应用尤为重要。
- **应用前景**：这项技术可以应用于虚拟和增强现实中的对象重照明、更真实的3D剪贴画以及交互式照明设计。

### 未来工作
- **深度校正**：作者提出了一种方法，可以捕捉不同深度的环境遮罩，从而在合成时考虑物体与背景之间的相对深度。这需要在不同深度的背景下拍摄物体，并通过线性插值来构造任意深度的矩形区域。
- **改进方法**：作者计划进一步研究如何减少捕获环境遮罩所需的图像数量，以及如何更准确地处理光泽和半透明表面的反射和折射。

### 总结
这篇论文的核心贡献在于提出了一种新的环境遮罩技术，能够捕捉并重现物体的复杂光学特性，使得在新环境中的合成效果更加真实。通过实验验证，作者展示了该技术在处理透明和反光物体时的优越性能，并探讨了其在虚拟和增强现实中的应用潜力。未来的工作将集中在提高捕获过程的效率和准确性，以及扩展技术的应用范围。


# 方法部分详解

#### 1. 环境遮罩（Environment Matting）

环境遮罩的过程旨在从真实场景中提取前景物体及其对光线的折射和反射特性。具体步骤如下：

1. **使用结构化光系统**：作者使用了结构化光系统来捕捉物体的折射和反射特性。物体被放置在多个显示器前，这些显示器显示不同的图案（称为背景幕和侧幕）。每个图案都被拍摄两次：一次是没有物体的参考图像，一次是有物体的对象图像。

2. **提取参数**：通过比较参考图像和对象图像，提取每个像素的前景颜色 $ F $、像素覆盖值 $ \alpha $ 和环境遮罩参数 $ \{R_i, A_i\} $。这些参数描述了物体如何折射和反射环境中的光线。

3. **分阶段处理**：为了简化问题，作者将提取过程分为四个阶段：
   - **粗略估计覆盖度**：首先将每个像素分类为覆盖或未覆盖。使用形态学操作（如开运算和闭运算）来清理 alpha 通道，去除孤立的覆盖或未覆盖像素。
   - **确定前景颜色和反射系数**：对于覆盖的像素，使用两个不同颜色的背景幕图像来求解前景颜色 $ F $ 和反射系数 $ R_1 $。
   - **确定区域范围和精细估计覆盖度**：通过最小化目标函数来确定背景区域的范围 $ A_1 $，并精细估计边界像素的 $ \alpha $ 值。
   - **处理侧幕**：通过类似的方法处理侧幕，以捕捉来自不同方向的光线。

#### 2. 环境合成（Environment Compositing）

环境合成的过程将提取的环境遮罩应用于新的背景图像，以实现真实的折射和反射效果。具体步骤如下：

1. **实现环境合成方程**：使用提取的环境遮罩参数，通过环境合成方程 $ C = F + (1 - \alpha) B + \sum_{i=1}^m R_i M(T_i, A_i) $ 来合成新的图像。其中，$ C $ 是合成后的颜色，$ F $ 是前景颜色，$ B $ 是背景颜色，$ R_i $ 是反射系数，$ M(T_i, A_i) $ 是纹理映射操作。

2. **纹理映射**：为了提高合成速度，作者使用了快速的纹理映射技术，如求和面积表（summed area tables），以避免 aliasing 问题。对于具有放大效果的物体，使用更高分辨率的纹理映射来存储背景图像。

3. **深度校正**：为了处理不同深度的背景，作者提出了一种方法，通过在不同深度的背景下拍摄物体，提取多个环境遮罩，并使用线性插值来构造任意深度的背景区域。

### 关键数值结果和方法细节

- **提取过程的时间**：提取过程大约需要 10 到 20 分钟每张环境图，运行在 Intel Pentium II 400MHz 的计算机上。
- **合成速度**：合成过程非常快，可以达到每秒 4 到 40 帧的速度。
- **纹理映射的分辨率**：为了处理 lenticular 物体，使用了比显示分辨率更高的纹理映射分辨率。

### 总结

这篇论文的方法部分详细介绍了如何通过结构化光系统和数学优化方法来提取环境遮罩，并通过纹理映射技术实现高效的环境合成。这种方法能够捕捉物体的复杂光学特性，并在新的环境中实现真实的视觉效果。

# 算法详解

1. **环境遮罩方程**：
   环境遮罩方程是文章的核心内容，它将传统的图像合成方程扩展到能够处理折射和反射效果。传统的数字合成方程为：
   $$
   C = F + (1 - \alpha)B
   $$
   其中，$ C $ 是最终合成的颜色，$ F $ 是前景元素的颜色，$ B $ 是背景的颜色，$ \alpha $ 是前景元素的不透明度。在环境遮罩中，此方程被扩展为：
   $$
   C = F + (1 - \alpha)B + \sum_{i=1}^m R_i \cdot M(T_i, A_i)
   $$
   其中，$ R_i $ 是反射和折射系数，$ M(T_i, A_i) $ 是对纹理映射 $ T_i $ 在区域 $ A_i $ 上的平均值。这个方程表明，最终的合成颜色不仅取决于前景和背景颜色，还取决于从环境中反射和折射的光线。

2. **反射和折射系数的计算**：
   为了计算反射和折射系数 $ R_i $，文章提出了一种优化方法。通过将物体放置在带有结构化图案的背景幕和侧幕前，并拍摄多张图像，可以提取出 $ R_i $ 的值。例如，对于背景幕 $ T_1 $，通过比较物体在不同背景颜色下的图像，可以得到：
   $$
   R_1(\alpha) = \frac{C - C'}{B - B'} - (1 - \alpha)
   $$
   其中，$ C $ 和 $ C' $ 是物体在不同背景颜色 $ B $ 和 $ B' $ 下的像素颜色。

3. **纹理映射和区域估计**：
   文章使用纹理映射和区域估计来捕捉物体对环境光线的反射和折射。通过将环境光线分解为多个纹理映射 $ T_i $，可以分别计算每个纹理映射在物体上的贡献。区域 $ A_i $ 表示纹理映射 $ T_i $ 在物体上的有效区域。为了估计区域 $ A_i $，文章使用了结构化光技术，并通过优化目标函数来确定最佳的区域范围。

4. **高斯加权纹理映射**：
   为了处理具有光泽表面的物体，文章提出了一种高斯加权的纹理映射方法。与传统的箱式滤波器不同，这种方法使用高斯权重来计算纹理映射的平均值。这可以更好地近似现实世界中物体对光线的反射和折射。

### 算法公式及含义

1. **环境遮罩方程**：
   $$
   C = F + (1 - \alpha)B + \sum_{i=1}^m R_i \cdot M(T_i, A_i)
   $$
   这是核心方程，用于合成新环境中的物体图像。各项的含义如下：
   - $ C $：最终合成的像素颜色。
   - $ F $：前景物体的像素颜色。
   - $ \alpha $：前景物体的不透明度（覆盖度）。
   - $ B $：背景图像的像素颜色。
   - $ R_i $：表示物体反射和折射光线的系数。
   - $ M(T_i, A_i) $：对纹理映射 $ T_i $ 在区域 $ A_i $ 上的平均值。

2. **反射和折射系数的计算**：
   $$
   R_1(\alpha) = \frac{C - C'}{B - B'} - (1 - \alpha)
   $$
   该公式用于计算背景幕 $ T_1 $ 的反射和折射系数。其中，$ C $ 和 $ C' $ 是物体在不同背景颜色 $ B $ 和 $ B' $ 下的像素颜色。通过比较这两个图像，可以分离出物体的反射和折射特性。

3. **目标函数的优化**：
   用于确定区域 $ A_i $ 和反射系数 $ R_i $ 的目标函数如下：
   $$
   E = \sum_{j=1}^n \left\| C_j - \left( F(\alpha) + (1 - \alpha) B_j + R_1(\alpha) \cdot M(T_j, A_1) \right) \right\|^2
   $$
   其中，$ C_j $ 和 $ B_j $ 分别是物体图像和参考图像的像素颜色。目标函数通过最小化多个图像的误差来优化参数 $ \alpha $、$ R_i $ 和区域 $ A_i $。

### 算法的改进和扩展

1. **高斯加权纹理映射**：
   为了处理具有光泽表面的物体，文章提出了一种高斯加权的纹理映射方法。这可以更好地近似现实世界中物体对光线的反射和折射，从而提高合成图像的质量。

2. **深度校正**：
   文章提出了一种深度校正的方法，用于处理不同深度的背景。通过捕捉不同深度的环境遮罩，并使用线性插值来构造任意深度的背景区域，可以合成出更逼真的图像。

3. **多视图环境遮罩**：
   文章还探讨了捕捉多个视图下的环境遮罩的方法。通过采集不同视图下的图像，并使用视图插值技术，可以生成具有逼真反射和折射效果的动画。


# 原文翻译

## 环境遮罩和合成
Douglas E. Zongker, Dawn M. Werner, Brian Curless, David H. Salesin
1华盛顿大学 2微软研究

### 摘要
本文介绍了一种新的过程，称为环境遮罩（environment matting），它不仅从真实场景中捕捉前景物体及其传统的不透明遮罩，还捕捉了该物体如何折射和反射光线的描述，我们称之为环境遮罩。然后可以使用环境合成（environment compositing）将前景物体放置在新环境中，在该环境中它将折射和反射来自该场景的光线。以这种方式捕捉的物体不仅表现出镜面反射，还表现出光泽和半透明效果，以及根据波长选择性地衰减和散射光线。此外，环境合成过程主要通过纹理映射操作进行，足够快，可以在桌面PC上以交互速度运行。我们将结果与真实场景中相同物体的照片进行比较。该工作的应用包括虚拟和增强现实中的物体重照明、更真实的3D剪贴画和交互式照明设计。

### 1 引言
遮罩和合成是图形学中的基本操作。在遮罩过程中，从背景图像中提取任意形状的前景元素。通过此过程提取的遮罩描述了前景元素在每个点的不透明度。在合成过程中，前景元素被放置在新的背景图像上，使用遮罩来遮挡前景元素遮挡的新背景部分。遮罩和合成最初是为电影和视频制作开发的[11]，例如，经常用于将演员的图像（在工作室中拍摄，背景受控）放置到另一个环境中。1984年，Porter和Duff[20]引入了遮罩的数字模拟——alpha通道，并展示了带有alpha的合成图像在创建复杂数字图像中的用途。1996年，Smith和Blinn[25]描述了从真实场景中提取alpha通道的数学框架，给定一对背景图像或前景元素颜色的某些假设。

尽管遮罩和合成在电影、视频和计算机图形制作中证明了其巨大的用途，但它们仍然未能模拟两个对现实感至关重要的关键效果：
- 透明物体表现出的折射；
- 在掠角处看到的光亮物体和物体表现出的反射。

此外，对于半透明或光泽材料，折射和反射进一步与各种光散射效应耦合。对于有色材料，折射和反射还可能表现出根据波长选择性衰减和散射光线的现象。

在本文中，我们将传统的遮罩和合成过程推广到包括所有这些效果。我们称之为环境遮罩和合成的结果过程，不仅能够捕捉前景物体及其传统遮罩，还能描述该物体如何折射和反射光线，我们称之为环境遮罩。然后可以将前景物体放置在新环境中，在该环境中它将折射和反射来自该场景的光线。虽然我们捕捉的环境遮罩仅提供了物体如何真正折射和反射光线的近似，但我们发现它们在真实场景中产生了令人信服的结果。此外，我们的环境遮罩表示使得环境合成主要可以通过简单的纹理映射进行。因此，对于合理大小的环境，这个过程可以在廉价的PC上以交互速度进行。图1展示了以这种方式捕捉的水杯并合成到两个新背景中。

### 1.1 相关工作
本文描述的工作结合了计算机图形学中许多不同领域的研究。

研究人员通过多种方式增强像素，以实现更灵活的图像合成。Porter和Duff的每个像素的alpha允许图像以层的形式获取或渲染，然后组合[20]。层可以独立修改，然后简单地重新组合。如上所述，他们的合成方法不考虑反射、折射或有色透明度。

Gershbein[12]通过深度、表面法线和着色参数增强像素，然后为可以以交互速度移动的光源执行每像素着色计算。Dorsey等人[10]在各种照明条件下渲染场景，然后通过对渲染结果进行线性组合来合成新图像。类似地，Nimeroff等人[19]计算在日光条件下预渲染的图像的线性组合。通过适当地近似日光的角度分布，他们构建了可操控的基函数，以模拟任意太阳位置的日光。该方法已在具有漫反射表面和光滑变化的照明场景中得到验证。

几位研究人员探索了在缓存结果的同时进行光线追踪的方法，以实现高效的重新渲染。S´equin和Smyrl[23]光线追踪场景并在每个像素存储着色表达式。在修改场景中物体的一些简单着色参数后，重新评估着色表达式以生成图像，而无需投射任何新光线。Bri´ere和Poulin[3]通过在光线树中存储光线路径的几何信息扩展了这一思想。重新着色可以像以前一样进行，但通过高效更新光线树可以快速处理场景几何的变化。Miller和Mondesir[18]光线追踪单个物体，并在每个像素存储光线树，以便快速合成到由环境映射立方体的前后表面组成的环境中。这些方法受益于光线追踪的通用性，并模拟了有色反射和折射等现象。然而，这些场景是合成的，光泽和半透明表面的整体效果必须使用分布式光线追踪[7]等方法建模，需要每个像素多个光线树。

与增强像素颜色的合成场景相比，从真实图像中获取信息的任务更加复杂。蓝屏遮罩，由Vlahos[25]开创，依赖于与前景物体充分不同的单色背景。如上所述，Smith和Blinn[25]使用两个背景来解除前景物体颜色的限制。然而，即使使用两个背景，背景对前景的反射（称为蓝色溢出）仍然是个麻烦，并导致遮罩提取后物体透明度不正确。我们的方法试图将这种反射正确建模为从背景重新定向的光线。

为了获取我们的环境遮罩，我们可以一次点亮一个光点并扫描物体周围的环境。覆盖这个区域需要$O(n^2)$张图像，其中$n^2$与物体周围环境的面积成正比。相反，我们从结构光范围扫描文献中获得灵感。使用扫描光平面，$O(n)$张图像可以通过光学三角测量获取形状[1]。通过投影逐渐细化的条纹图案，所需图像数量可以减少到$O(\log n)$[21]。使用强度梯度，理论上可以将图像数量减少到两张[5]；然而，这种方法对噪声高度敏感。提出了混合方法来管理图像数量和噪声敏感性之间的权衡[6, 16]。我们的环境遮罩方法基于分层条纹方法。然而，结构光测距仪假设物体是漫反射的，并试图将传感器的视线与投影光源的视线相交。在我们的情况下，表面通常假设相对光亮，甚至是折射的，传感器的视线可以任意重新映射到漫反射结构光图案上。

最后，已经开发了许多方法来将反射和折射物体渲染到环境中。Blinn和Newell[2]引入了环境（即反射）映射，以模拟几何物体对存储为纹理的环境的反射。Greene[14]改进了这一思想，以模拟一些有限的着色效果。Voorhies和Foran[26]后来展示了使用纹理映射硬件的交互式环境映射。此外，Kay和Greenberg[17]开发了一种快速渲染折射物体的近似方法。这些方法基于物体几何，并且据我们所知，没有一种方法能够准确地表示折射或在交互速度下模拟空间变化的半透明和光泽。


Miller和Mondesir的超精灵渲染[18]与我们的渲染方法最接近；然而，它使用超采样进行抗锯齿。通过使用求和面积表[8]，我们可以实现纹理抗锯齿，以及在交互速度下实现显著的光泽或半透明效果。

### 1.2 概述
接下来的三个部分依次讨论：我们的新表示方法，用于捕捉前景元素的折射和反射属性的环境遮罩（第2节）；从真实场景中提取环境遮罩的环境遮罩过程（第3节）；以及将前景元素放置到新环境中的环境合成过程（第4节）。对主要结果的讨论（第5节）之后，概述了一些初步结果，这些结果扩展了我们的方法，允许在合成时设置物体和背景的相对深度（第6节）。我们以一些未来研究的想法结束（第7节）。

