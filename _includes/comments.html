<!-- Gitalk 评论组件 -->
{% if site.gitalk.enable %}
<div id="gitalk-container"></div>

<!-- 引入 Gitalk 相关资源 -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.css">
<script src="https://cdn.jsdelivr.net/npm/gitalk@1/dist/gitalk.min.js"></script>

<script type="text/javascript">
  // 获取页面唯一标识
  var gitalkId = '{{ page.url | slugify }}';
  // 如果标识超过50个字符，则取其哈希值的后50个字符
  if (gitalkId.length > 50) {
    gitalkId = gitalkId.substr(gitalkId.length - 50);
  }
  
  // 尝试从localStorage获取Gitalk配置（仅用于本地开发）
  var clientID = "{{ site.gitalk.clientID }}";
  var clientSecret = "{{ site.gitalk.clientSecret }}";
  
  // 在浏览器环境中，尝试从localStorage获取配置
  if (typeof window !== 'undefined' && window.localStorage) {
    var storedClientID = localStorage.getItem('gitalk_client_id');
    var storedClientSecret = localStorage.getItem('gitalk_client_secret');
    
    if (storedClientID) clientID = storedClientID;
    if (storedClientSecret) clientSecret = storedClientSecret;
  }
  
  // 检查是否有有效的配置
  if (clientID === 'YOUR_CLIENT_ID' || clientSecret === 'YOUR_CLIENT_SECRET' || clientID === '' || clientSecret === '') {
    document.getElementById('gitalk-container').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">' +
      '<p>Gitalk 评论系统尚未配置。</p>' +
      '<p>请查看 <a href="{{ site.baseurl }}/pages/gitalk-setup.html">Gitalk 安全配置指南</a> 了解如何配置。</p>' +
      '</div>';
  } else {
    try {
      var gitalk = new Gitalk({
        clientID: clientID,
        clientSecret: clientSecret,
        repo: "{{ site.gitalk.repo }}",
        owner: "{{ site.gitalk.owner }}",
        admin: {{ site.gitalk.admin | jsonify }},
        id: gitalkId,
        title: "{{ page.title }}",
        distractionFreeMode: false
      });
      
      gitalk.render('gitalk-container');
    } catch (e) {
      console.error("Gitalk 初始化失败:", e);
      document.getElementById('gitalk-container').innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">' +
        '<p>Gitalk 评论系统初始化失败。</p>' +
        '<p>错误信息: ' + e.message + '</p>' +
        '</div>';
    }
  }
</script>

<style>
  /* Gitalk 样式调整 */
  #gitalk-container {
    margin-top: 30px;
  }
  
  /* 暗色模式支持 */
  html.dark .gt-container .gt-btn {
    background-color: #30363d;
    border-color: #30363d;
  }
  
  html.dark .gt-container .gt-btn-preview {
    background-color: #161b22;
    color: #c9d1d9;
  }
  
  html.dark .gt-container .gt-header-textarea {
    background-color: #0d1117;
    color: #c9d1d9;
    border-color: #30363d;
  }
  
  html.dark .gt-container .gt-header-preview {
    background-color: #0d1117;
    color: #c9d1d9;
    border-color: #30363d;
  }
  
  html.dark .gt-container .gt-comment-content {
    background-color: #161b22;
    color: #c9d1d9;
    border-color: #30363d;
  }
  
  html.dark .gt-container .gt-comment-body {
    color: #c9d1d9;
  }
  
  html.dark .gt-container a {
    color: #58a6ff;
  }
  
  html.dark .gt-container .gt-svg svg {
    fill: #8b949e;
  }
  
  html.dark #gitalk-container pre {
    background-color: #161b22;
    color: #c9d1d9;
  }
</style>
{% endif %} 